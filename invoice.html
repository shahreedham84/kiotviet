<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Papadums Invoice (Offline + Intent Print)</title>
<style>
* { box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 0; }
.receipt { width: 58mm; margin: auto; padding: 6px; background: #fff; color: #000; }
.center { text-align: center; }
.right { text-align: right; }
.bold { font-weight: 700; }
.small { font-size: 11px; }
.items { margin-top: 6px; }
.items .row { display: grid; grid-template-columns: 1fr 55px 25px 55px; align-items: center; padding: 3px 0; border-bottom: 1px dashed #ddd; font-size: 12px; }
.items .row.header { font-weight: 700; border-bottom: 1px solid #000; }
.totals { margin-top: 6px; font-size: 13px; }
.totals .line { display: flex; justify-content: space-between; padding: 2px 0; }
.header-title { font-weight: 700; font-size: 13px; }
.roundbox { border:1px solid #000; padding:4px 8px; border-radius:10px; font-size:12px; font-weight:700; display:inline-block; }
.no-print { margin-top: 8px; text-align: center; }
.no-print button, .no-print input { margin: 4px; padding: 6px 10px; border-radius: 6px; font-weight: bold; }
.no-print input { width: 160px; text-align: center; border:1px solid #ccc; padding:6px; }
.status-dot { width: 12px; height: 12px; border-radius: 50%; display:inline-block; background:gray; margin-top:8px; }
.status-label { font-size:13px; color:#555; margin-top:4px; display:block; }
.status-ip { font-size:12px; color:#333; margin-top:2px; }
@media print {
  html, body { width: 58mm; margin:0; padding:0; }
  .no-print { display: none !important; }
  .receipt { width: 58mm!important; margin: 2mm auto; padding:2mm 3mm; }
  @page { size: 58mm auto; margin:0; }
}
</style>
</head>
<body>

<div class="receipt" id="invoice">
  <!-- Header -->
  <div class="center" style="margin-bottom:6px;">
    <div class="header-title">PAPADUMS INDIAN CUISINE</div>
    <div class="small"><b>Address:</b> 35 Tr·∫ßn H∆∞ng ƒê·∫°o, P. Nguy·ªÖn Th√°i B√¨nh, Q1, TP.HCM</div>
    <div class="small"><b>Phone:</b> 0946 024 520</div>
  </div>

  <!-- Table / Time -->
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-top:4px;">
    <div>
      <div class="roundbox" id="tableBox">‚Äî</div>
      <div class="small" style="margin-top:4px;">
        <b>Time in:</b><br>
        <span id="timeInDate"></span><br>
        <span id="timeInTime"></span>
      </div>
    </div>
    <div style="text-align:right;">
      <div class="bold">INVOICE</div>
      <div class="small"><b>Bill No:</b> <span id="billLabel">‚Äî</span></div>
      <div class="small"><b>Time out:</b> <span id="timeOutLabel">‚Äî</span></div>
    </div>
  </div>

  <!-- Items -->
  <div class="items" id="itemsList">
    <div class="row header">
      <div>Item</div><div class="right">Price</div><div class="right">Qty</div><div class="right">Amt</div>
    </div>
  </div>

  <!-- Totals -->
  <div style="border-top:1px solid #000;margin-top:6px;padding-top:6px">
    <div class="totals">
      <div class="line"><div><b>Total:</b></div><div id="totalPrice" class="right">0</div></div>
      <div class="line"><div>Discount:</div><div id="discountLabel" class="right">0</div></div>
      <div class="line"><div>VAT (8%):</div><div id="vatAmount" class="right">0</div></div>
      <div class="line" style="font-weight:700;font-size:15px;"><div>TOTAL:</div><div id="grandTotal" class="right">0</div></div>
    </div>
  </div>

  <!-- Footer -->
  <div class="center" style="margin-top:6px;">
    <div class="bold">PAPADUMS INDIAN CUISINE</div>
    <div class="small"><b>Address:</b> 35 Tr·∫ßn H∆∞ng ƒê·∫°o, P. Nguy·ªÖn Th√°i B√¨nh, Q1, TP.HCM</div>
    <div class="small"><b>Phone:</b> 0946 024 520</div>
    <div class="small">WiFi: <b>PAPADUMS INDIAN CUISINE 5G</b></div>
    <div class="small">Pass: everyday</div>
    <canvas id="qrImg" width="80" height="80" style="margin:4px 0;"></canvas>
    <div class="small" style="margin-top:4px;">Invoice includes VAT</div>
  </div>

  <!-- Buttons -->
  <div class="no-print">
    <input id="printerIp" placeholder="192.168.1.182:9100" value=""><br>
    <button id="testPrinterBtn">üîç Test Printer</button>
    <button id="printBtn">üñ®Ô∏è Android Print</button>
    <button id="downloadPngBtn">‚¨áÔ∏è Download PNG</button>
    <div>
      <span class="status-dot" id="printerStatus"></span>
      <span class="status-label" id="printerStatusText">Status: Unknown</span>
      <span class="status-ip" id="printerIpDisplay"></span>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
// ---------- Render Invoice ----------
function renderInvoice() {
  const saved = localStorage.getItem("papadumsInvoiceData");
  if(!saved) return console.warn("No invoice data found in localStorage");
  const data = JSON.parse(saved);

  let tableNum = data.table ? data.table.replace(/table/i,"").trim() : "‚Äî";
  document.getElementById("tableBox").textContent = `Ban: ${tableNum}`;

  if(!data.billNo) data.billNo = `HD00${Math.floor(1000 + Math.random() * 9000)}`;
  document.getElementById("billLabel").textContent = data.billNo;

  const now = new Date();
  document.getElementById("timeInDate").textContent = now.toLocaleDateString('en-GB');
  document.getElementById("timeInTime").textContent = now.toLocaleTimeString('en-GB',{hour12:false});
  document.getElementById("timeOutLabel").textContent = now.toLocaleTimeString('en-GB',{hour12:false});

  const itemsList = document.getElementById("itemsList");
  itemsList.querySelectorAll(".row:not(.header)").forEach(r=>r.remove());

  if(Array.isArray(data.items) && data.items.length > 0){
    data.items.forEach(it=>{
      const row = document.createElement("div");
      row.className = "row";
      const qty = it.qty || 1;
      const price = it.price || 0;
      row.innerHTML = `<div>${it.name}</div><div class="right">${price.toLocaleString()}</div><div class="right">${qty}</div><div class="right">${(price*qty).toLocaleString()}</div>`;
      itemsList.appendChild(row);
    });
  } else {
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `<div colspan="4" style="text-align:center;">No items</div>`;
    itemsList.appendChild(row);
  }

  const total = data.items?.reduce((sum,i)=>sum+(i.price*i.qty),0) || 0;
  const discount = data.discount || 0;
  const vat = total * 0.08;
  const grandTotal = total + vat - discount;

  document.getElementById("totalPrice").textContent = total.toLocaleString();
  document.getElementById("discountLabel").textContent = discount.toLocaleString();
  document.getElementById("vatAmount").textContent = vat.toLocaleString();
  document.getElementById("grandTotal").textContent = grandTotal.toLocaleString();

  // Generate QR
  new QRious({ element: document.getElementById("qrImg"), value: `Papadums Invoice ${data.billNo}`, size: 80 });
}

// ---------- Printer Status ----------
function updateStatus(ok,msg){
  const dot = document.getElementById("printerStatus");
  const text = document.getElementById("printerStatusText");
  const ipDisplay = document.getElementById("printerIpDisplay");
  dot.style.background = ok ? "limegreen" : "red";
  text.textContent = msg;
  const ipRaw = document.getElementById("printerIp").value.trim();
  ipDisplay.textContent = ipRaw ? `IP: ${ipRaw}` : "";
  setTimeout(()=>{ dot.style.background="gray"; text.textContent="Status: Unknown"; },3000);
}

// ---------- Load data ----------
function loadInvoiceData(){ renderInvoice(); }

// ---------- Test Printer ----------
document.getElementById("testPrinterBtn").addEventListener("click", ()=>{
  const ipRaw = document.getElementById("printerIp").value.trim();
  if(!ipRaw) return updateStatus(false,"Enter printer IP:port");
  if(window.AndroidBridge && typeof AndroidBridge.testPrinterConnection==="function"){
    try { AndroidBridge.testPrinterConnection(ipRaw); updateStatus(true,`Testing ${ipRaw}`); } 
    catch(e){ updateStatus(false,"Test failed"); } return;
  }
  fetch(`http://${ipRaw}`, { method:"HEAD", mode:"no-cors" }).then(()=> updateStatus(true, `üü¢ ${ipRaw} reachable`))
  .catch(()=> updateStatus(false, `üî¥ ${ipRaw} unreachable`));
});

// ---------- Print via Intent:// (silent Android) ----------
document.getElementById("printBtn").addEventListener("click", async ()=>{
  const invoice = document.getElementById("invoice");
  const canvas = await html2canvas(invoice,{scale:2,backgroundColor:"#ffffff"});
  const imgData = canvas.toDataURL("image/png");

  const ipRaw = document.getElementById("printerIp").value.trim();
  if(!ipRaw) return updateStatus(false,"Enter printer IP:port");

  // Save IP
  localStorage.setItem("assetPrinterIp", ipRaw);

  const payload = { ip: ipRaw.split(":")[0], port: parseInt(ipRaw.split(":")[1]||"9100"), image: imgData.split(",")[1] };
  const intentUrl = `intent://printimg/${encodeURIComponent(JSON.stringify(payload))}#Intent;scheme=papsprint;package=com.pos.printservice;end`;

  window.location.href = intentUrl;
  updateStatus(true, `‚úÖ Sent silent print intent to ${ipRaw}`);
});

// ---------- Download PNG ----------
document.getElementById("downloadPngBtn").addEventListener("click", async ()=>{
  try{
    const invoice = document.getElementById("invoice");
    const canvas = await html2canvas(invoice,{scale:2,backgroundColor:"#ffffff"});
    const imgData = canvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.href = imgData;
    link.download = `Invoice_${Date.now()}.png`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    updateStatus(true,"üì∏ PNG downloaded");
  } catch(e){ updateStatus(false,"‚ùå PNG download failed"); }
});

// ---------- Save printer IP ----------
document.getElementById("printerIp").addEventListener("change",(e)=>{ localStorage.setItem("assetPrinterIp", e.target.value.trim()); });

window.addEventListener("load", ()=>{
  const savedIp = localStorage.getItem("assetPrinterIp");
  if(savedIp) document.getElementById("printerIp").value = savedIp;
  loadInvoiceData();
});
</script>
</body>
</html>
