<!DOCTYPE html>
<html lang="en" translate="no" class="notranslate">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KOT Print (Asset)</title>
<style>
  @page { size: 80mm auto; margin: 4mm 5mm; } 
  body { 
    font-family: Arial, Helvetica, sans-serif; 
    width: 76mm;
    margin: 0 auto; 
    font-size: 14px; 
    background: #fff;
  }
  .receipt { 
    width: 100%; 
    background: #fff; 
    padding: 10px 8px;
    box-sizing: border-box;
  }
  .copy { text-align: left; font-weight: bold; margin-bottom: 3px; }
  h2 { text-align: center; margin: 2px 0 5px 0; font-weight: 900; font-size: 18px; }
  .meta { font-size: 14px; margin: 1px 0; display: flex; align-items: center; gap: 4px; }
  .meta b { font-weight: bold; }
  .code-line { font-size: 13px; margin: 4px 0 6px 0; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 4px 0; text-align: left; border-bottom: 1px solid #000; font-size: 14px; word-break: break-word; }
  th { font-weight: bold; }
  .no-print { margin-top: 8px; text-align: center; }
  .no-print button, .no-print input { margin: 4px; padding: 6px 10px; border-radius: 6px; font-weight: bold; }
  .no-print input { width: 160px; text-align: center; border:1px solid #ccc; padding:6px; }
  .status-dot { width: 12px; height: 12px; border-radius: 50%; display:inline-block; background:gray; margin-top:8px; }
  .status-label { font-size:13px; color:#555; margin-top:4px; display:block; }
  .status-ip { font-size:12px; color:#333; margin-top:2px; }
  @media print { .no-print { display:none !important; } }
</style>
</head>
<body>

<div class="receipt" id="receipt">
  <div class="copy">Copies 1</div>
  <h2>CH·∫æ BI·∫æN</h2>
  <div class="meta"><b>B√†n:</b><span id="tableNum">‚Äî</span></div>
  <div class="meta"><b>Ph·ª•c v·ª•:</b><span id="serverName">Qu·ª≥nh Anh</span></div>
  <div class="code-line" id="codeLine"></div>

  <table>
    <thead>
      <tr><th>M√≥n</th><th>DVT</th><th>SL</th></tr>
    </thead>
    <tbody id="itemList">
      <tr><td colspan="3" style="text-align:center;">Waiting for data...</td></tr>
    </tbody>
  </table>
</div>

<div class="no-print">
  <input id="printerIp" placeholder="192.168.1.182:9100" value=""><br>
  <button id="testPrinterBtn">üîç Test Printer</button>
  <button id="fetchDataBtn">üîÑ Fetch Data</button>
  <button id="printBtn">üñ®Ô∏è Android Print</button>
  <button id="downloadPngBtn">‚¨áÔ∏è Download PNG (80mm)</button>
  <div>
    <span class="status-dot" id="printerStatus"></span>
    <span class="status-label" id="printerStatusText">Status: Unknown</span>
    <span class="status-ip" id="printerIpDisplay"></span>
  </div>
</div>

<script src="kot_data.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let injectedOrder = null;

// ----- Receive KOT from AndroidBridge or external source -----
window.receiveKOTData = function(jsonStr){
  try {
    injectedOrder = JSON.parse(jsonStr);
    localStorage.setItem("papadumsInvoiceData", JSON.stringify(injectedOrder));
    renderOrder(injectedOrder);
    sendAckToBrowser();
  } catch(e){
    console.error("receiveKOTData parse failed", e);
  }
};

// Broadcast ACK to other tabs (optional)
function sendAckToBrowser(){
  try {
    const bc = new BroadcastChannel('kot_channel');
    bc.postMessage({ type: "ACK", ok: true, ts: Date.now() });
    bc.close();
  } catch(e){}
}

// ----- Render KOT receipt -----
function renderOrder(data){
  if(!data) return;
  let tableNum = data.table || "‚Äî";
  tableNum = tableNum.toString().replace(/table\s*/i, "");
  document.getElementById("tableNum").textContent = tableNum;
  document.getElementById("serverName").textContent = data.server || "Qu·ª≥nh Anh";

  const now = new Date();
  document.getElementById("codeLine").textContent =
    `${Math.floor(Math.random()*90+10)}-${Math.floor(Math.random()*90+10)} ${now.toLocaleTimeString('en-GB',{hour12:false})} ${now.toLocaleDateString('en-GB')}`;

  const tbody = document.getElementById("itemList");
  tbody.innerHTML = "";
  if(!data.items || data.items.length===0){
    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">No items</td></tr>`;
  } else {
    data.items.forEach(it=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${it.name}</td><td>${it.unit||""}</td><td>${it.qty}</td>`;
      tbody.appendChild(tr);
    });
  }
  updateStatus(true, "‚úÖ Data loaded");
}

// ----- Printer status -----
function updateStatus(ok, msg){
  const dot = document.getElementById("printerStatus");
  const text = document.getElementById("printerStatusText");
  const ipDisplay = document.getElementById("printerIpDisplay");
  dot.style.background = ok ? "limegreen" : "red";
  text.textContent = msg;
  const ipRaw = document.getElementById("printerIp").value.trim();
  ipDisplay.textContent = ipRaw ? `IP: ${ipRaw}` : "";
  setTimeout(()=>{ dot.style.background="gray"; text.textContent="Status: Unknown"; }, 3000);
}

// ----- Load data from multiple sources -----
function loadPriorityData(){
  if(injectedOrder){ renderOrder(injectedOrder); return; }
  const saved = localStorage.getItem("papadumsInvoiceData");
  if(saved){ try { renderOrder(JSON.parse(saved)); return; } catch(e){} }
  if(window.kotFallbackData){ renderOrder(window.kotFallbackData); }
  else { updateStatus(false, "‚ö†Ô∏è No data found"); }
}

// Broadcast channel listener (optional)
try {
  const bc = new BroadcastChannel('kot_channel');
  bc.onmessage = (ev) => {
    if(ev.data?.type === "ORDER_DATA" && ev.data.data){
      localStorage.setItem("papadumsInvoiceData", JSON.stringify(ev.data.data));
      renderOrder(ev.data.data);
      bc.postMessage({ type: "ACK", ok: true, ts: Date.now() });
    }
  };
} catch(e){}

// ----- Buttons -----
document.getElementById("fetchDataBtn").addEventListener("click", loadPriorityData);

document.getElementById("testPrinterBtn").addEventListener("click", () => {
  const ipRaw = document.getElementById("printerIp").value.trim();
  if(!ipRaw) return updateStatus(false, "Enter printer IP:port");
  fetch(`http://${ipRaw}`, { method:"HEAD", mode:"no-cors" }).then(()=> {
    updateStatus(true, `üü¢ ${ipRaw} reachable`);
  }).catch(()=> { updateStatus(false, `üî¥ ${ipRaw} unreachable`); });
});

// ----- Print KOT via AndroidBridge (MainActivity.kt compatible) -----
document.getElementById("printBtn").addEventListener("click", async () => {
  const ipRaw = document.getElementById("printerIp").value.trim();
  if(!ipRaw) return updateStatus(false, "Enter printer IP:port");

  const [ip, port] = ipRaw.split(":");
  const printerPort = parseInt(port || "9100");

  const receipt = document.getElementById("receipt");
  try {
    const canvas = await html2canvas(receipt, { scale: 2, backgroundColor: "#ffffff" });
    const imgData = canvas.toDataURL("image/png").split(",")[1]; // Base64 only

    const payload = {
      ip: ip,
      port: printerPort,
      image: imgData
    };

    localStorage.setItem("assetPrinterIp", ipRaw);

    // Trigger Android silent print intent
    window.location.href = `intent://printimg/${encodeURIComponent(JSON.stringify(payload))}#Intent;scheme=papsprint;end;`;
    updateStatus(true, `‚úÖ Print job sent to ${ipRaw}`);
  } catch (e) {
    updateStatus(false, "‚ùå Print failed");
    console.error(e);
  }
});

// ----- Download PNG -----
document.getElementById("downloadPngBtn").addEventListener("click", async () => {
  try {
    const receipt = document.getElementById("receipt");
    const canvas = await html2canvas(receipt, { scale: 2, backgroundColor: "#ffffff" });
    const imgData = canvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.href = imgData;
    link.download = `KOT_${Date.now()}_80mm.png`;
    document.body.appendChild(link);
    link.click();
    link.remove();
    updateStatus(true, "üì∏ PNG downloaded (80mm)");
  } catch(e) {
    updateStatus(false, "‚ùå PNG download failed");
  }
});

document.getElementById("printerIp").addEventListener("change", (e) => {
  localStorage.setItem("assetPrinterIp", e.target.value.trim());
});

window.addEventListener("load", () => {
  const savedIp = localStorage.getItem("assetPrinterIp");
  if(savedIp) document.getElementById("printerIp").value = savedIp;
  loadPriorityData();
});
</script>
</body>
</html>
